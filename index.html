<!DOCTYPE html>

<html>

<head>

	<title> Tarea 1 PDI </title>
	<meta http-equiv="Content-Type" content="text/html" charset="UTF-8"/>
	<meta name="viewport" content="width=device-width"/>

</head>

<body bgcolor="#E6E6FA">

<div>
<input type="file" id="input">
 <select id="selection">
  <option value="negativo">Negativo</option>
  <option value="rotacw">Rotar CW</option>
  <option value="rotaccw">Rotar CCW</option>
  <option value="espejoh">Espejo Horizontal</option>
  <option value="espejov">Espejo Vertical</option>
</select> 
 <input id="boton" type="submit" value="Go!">
</div>
<br>
<br>
<canvas id="canvas1" width="0" height="0" align="midle">
This text is displayed if your browser does not support HTML5 Canvas.
</canvas>


<script>
// Cuando el usuario escoge un archivo, se llama a la funcion handleFiles.
var inputElement = document.getElementById("input");
inputElement.addEventListener("change", handleFiles, false);

// Se crea el contexto del canvas a utilizar.
var canvas1 = document.getElementById('canvas1');
var ctx1 = canvas1.getContext('2d');

//Se crea un canvas auxiliar para trabajar y evitar posibles da침os al original.
canvas = document.createElement("canvas");
var ctx = canvas.getContext("2d");
var bitmap = {}; // los datos de la imagen.

// Controla cuando el usuario desea aplicar una transformacion
var inputElement = document.getElementById("boton");
inputElement.addEventListener("click", transform , false);


//  --------------------------------FUNCIONES ----------------------------------------------
            function handleFiles(e) {
             // Se abre el archivo.
                var file = e.target.files[0];
                var reader = new FileReader();
                reader.addEventListener("load", processimage, false);
                reader.readAsArrayBuffer(file);

            }
//  ------------------------------------------------------------------------------
            function processimage(e) {
             // se almacena el contenido del archivo en un buffer para procesarlo, obtener el mapa, y convertirlo a imagen.
                var buffer = e.target.result;
                getBMP(buffer);
                var imageData = convertToImageData();
                ctx1.putImageData(imageData, 0, 0);
            }
//  ------------------------------------------------------------------------------
            function getBMP(buffer) { 
            // se obtiene el mapa de bits de la imagen .
                var datav = new DataView(buffer);

                // Se lee y almacena la cabecera.
                bitmap.fileheader = {};
                bitmap.fileheader.bfType = datav.getUint16(0, true);
                bitmap.fileheader.bfSize = datav.getUint32(2, true);
                bitmap.fileheader.bfReserved1 = datav.getUint16(6, true);
                bitmap.fileheader.bfReserved2 = datav.getUint16(8, true);
                bitmap.fileheader.bfOffBits = datav.getUint32(10, true);

                // Se lee y almacena la informaci칩n de la cabecera.
                bitmap.infoheader = {};
                bitmap.infoheader.biSize = datav.getUint32(14, true);
                bitmap.infoheader.biWidth = datav.getUint32(18, true);
                bitmap.infoheader.biHeight = datav.getUint32(22, true);
                bitmap.infoheader.biPlanes = datav.getUint16(26, true);
                bitmap.infoheader.biBitCount = datav.getUint16(28, true);
                bitmap.infoheader.biCompression = datav.getUint32(30, true);
                bitmap.infoheader.biSizeImage = datav.getUint32(34, true);
                bitmap.infoheader.biXPelsPerMeter = datav.getUint32(38, true);
                bitmap.infoheader.biYPelsPerMeter = datav.getUint32(42, true);
                bitmap.infoheader.biClrUsed = datav.getUint32(46, true);
                bitmap.infoheader.biClrImportant = datav.getUint32(50, true);


                var start = bitmap.fileheader.bfOffBits, NumbClr = bitmap.infoheader.biClrUsed, off= 54;
                bitmap.stride = Math.floor((bitmap.infoheader.biBitCount * bitmap.infoheader.biWidth + 31) / 32) * 4;
                
                bitmap.palette = new Uint8Array(buffer,(bitmap.fileheader.bfOffBits-(NumbClr*4)), NumbClr*4);

                bitmap.pixels = new Uint8Array(buffer, start);

                resizeCanvas(bitmap.infoheader.biWidth,bitmap.infoheader.biHeight);
                
            }
//  ------------------------------------------------------------------------------
            function convertToImageData() { 
            // el mapa de bit se convierte en imagen.
                
                var Width = bitmap.infoheader.biWidth;
                var Height = bitmap.infoheader.biHeight;
                var imageData = ctx.createImageData(Width, Height);
                var data = imageData.data;
                var bmpdata = bitmap.pixels;
                var stride = bitmap.stride;
                var palette = bitmap.palette;


                if(bitmap.infoheader.biBitCount == 24) {
                    // se reorganizan los pixeles para poderlos meter en la estructura imageData que puede ser usada por el canvas.
                    for (var y = 0; y < Height; ++y) { 
                        for (var x = 0; x < Width; ++x) {

                            var index1 = (x + Width * (Height - y)) * 4;
                            var index2 = x * 3 + stride * y;
                            data[index1] = bmpdata[index2 + 2];
                            data[index1 + 1] = bmpdata[index2 + 1];
                            data[index1 + 2] = bmpdata[index2];
                            data[index1 + 3] = 255;

                        }
                    }

                } else if (bitmap.infoheader.biBitCount == 8) {
                    // se recorre el arreglo de indices reemplazando los indices por el color indexado en la paleta y almacenandolo en la estructura imageData que puede ser usada por el canvas.
                    var cont=0;

                    for (var y = 0; y < Height; ++y) { 
                        for (var x = 0; x < Width; ++x) {

                            var index1 = (x + Width * (Height - y)) * 4;
                            var index2 = bmpdata[cont];
                            cont++;

                            data[index1] = palette[index2*4 + 2]; // el R
                            data[index1 + 1] = palette[index2*4 + 1];// el G
                            data[index1 + 2] = palette[index2*4]; // el B
                            data[index1 + 3] = 255; // el alfa

                        }
                    }

                } 

                return imageData;
            }
//  ------------------------------------------------------------------------------
            function resizeCanvas(width, height) { 
            // se cambia el tama침o del canvas dependiendo del tama침o de la imagen.
	            canvas1.width = width;
	            canvas1.height = height;
    		}
//  ------------------------------------------------------------------------------
            // function indextocolor(){
            // // Cambia el arrecho de indices de pixeles a un arreglo de RGB.
            //     var cont=0;
            //     var palette = bitmap.palette;
            //     var bmpdata = JSON.parse(JSON.stringify(bitmap.pixels))
            //     //var bmpdata = bitmap.pixels.slice();

            //     for (var x = 0; x < bmpdata.length; x++) {

            //         index1 = bitmap.pixels[x];

            //         bmpdata[cont] = palette[index1*4]; // el B
            //         bmpdata[cont + 1] = palette[index1*4 + 1];// el G
            //         bmpdata[cont + 2] = palette[index1*4 + 2]; // el R

            //     }

            //     bitmap.pixels = bmpdata;

            //     console.log(bitmap.pixels);
            //     console.log(bmpdata);
            // }
//  ------------------------------------------------------------------------------
            function dec2bin(dec){
                //Transoformar la cadena de bits que leemos de a 8bits a solo gran string para poder manejarlo facilmente en el caso de 1 y 4bits.
                return (dec >>> 0).toString(2);
            }
//  ------------------------------------------------------------------------------
            function transform() {
            // Se elige la funcion de transformacion a usar, segun la escogida por el usuario.
                var option = document.getElementById("selection").value;

                if(option=="negativo"){
                    negative();
                } else if (option=="rotacw") {
                    rotatecw();
                }else if (option=="rotaccw") {
                    rotatecw();
                    rotatecw();
                    rotatecw();
                }else if (option=="espejoh") {
                    mirrorh();
                }else if (option=="espejov") {
                    mirrorv();
                }

                var imageData = convertToImageData(); 
                ctx1.putImageData(imageData, 0, 0);
            }
//  ------------------------------------------------------------------------------
            function negative () {

                if(bitmap.infoheader.biBitCount == 24) {
                    for(var x=0; x<bitmap.pixels.length;x++) {
                        bitmap.pixels[x] = 255 - bitmap.pixels[x];
                    }
                } else {
                    for(var x=0; x<bitmap.palette.length;x++) {
                        bitmap.palette[x] = 255 - bitmap.palette[x];
                    }
                }

            }
//  ------------------------------------------------------------------------------
            function mirrorh () {

                if(bitmap.infoheader.biBitCount == 24) {

                    var Height = bitmap.infoheader.biHeight;
                    var Width = bitmap.infoheader.biWidth;
                    var aux = bitmap.pixels.slice();

                    for (var y = 0; y < Height; ++y) { 
                        for (var x = 0; x < Width; ++x) {

                            var index1 = (x + Width * (Height - y)) * 3;
                            var index2 = x * 3 + bitmap.stride * y;

                            aux[index1] = bitmap.pixels[index2];
                            aux[index1 + 1] = bitmap.pixels[index2 + 1];
                            aux[index1 + 2] = bitmap.pixels[index2 + 2];
                        }
                    }

                    bitmap.pixels = aux;

                } else if (bitmap.infoheader.biBitCount == 8) {

                    var Height = bitmap.infoheader.biHeight;
                    var Width = bitmap.infoheader.biWidth;
                    var aux = bitmap.pixels.slice();

                    for (var y = 0; y < Height; ++y) { 
                        for (var x = 0; x < Width; ++x) {

                            var index1 = (x + Width * (Height - y)) ;
                            var index2 = x + bitmap.stride * y;

                            aux[index1] = bitmap.pixels[index2];
                        }
                    }

                    bitmap.pixels = aux;

                }
            }
//  ------------------------------------------------------------------------------
            function mirrorv () {

                if(bitmap.infoheader.biBitCount == 24) {

                    var Height = bitmap.infoheader.biHeight;
                    var Width = bitmap.infoheader.biWidth;
                    var aux = bitmap.pixels.slice();

                    for (var y = 0; y < Height; ++y) { 
                        for (var x = 0; x < Width; ++x) {

                            var index1 = x * 3 + bitmap.stride * y;
                            var index2 = ((bitmap.stride - 1) - (x * 3) ) + bitmap.stride * y;

                            aux[index1] = bitmap.pixels[index2 - 2];  // B 
                            aux[index1 + 1] = bitmap.pixels[index2 - 1]; // G
                            aux[index1 + 2] = bitmap.pixels[index2]; // R
                        }
                    }

                    bitmap.pixels = aux;

                }else if (bitmap.infoheader.biBitCount == 8) {

                    var Height = bitmap.infoheader.biHeight;
                    var Width = bitmap.infoheader.biWidth;
                    var aux = bitmap.pixels.slice();

                    for (var y = 0; y < Height; ++y) { 
                        for (var x = 0; x < Width; ++x) {

                            var index1 = x + bitmap.stride * y;
                            var index2 = ((bitmap.stride - 1) - x ) + bitmap.stride * y;

                            aux[index1] = bitmap.pixels[index2]; 
                        }
                    }

                    bitmap.pixels = aux;

                }
            }
//  ------------------------------------------------------------------------------
            function rotatecw() {

                if(bitmap.infoheader.biBitCount == 24) {

                    var Height = bitmap.infoheader.biHeight;
                    var Width = bitmap.infoheader.biWidth;
                    var aux = bitmap.pixels.slice();
                    var cont = 0;

                    for (var y = 0; y < Width; ++y) { 
                        for (var x = 0; x < Height; ++x) {

                            var index1 = y * 3 + bitmap.stride * x;

                            aux[cont] = bitmap.pixels[index1];  // B
                            aux[cont + 1] = bitmap.pixels[index1 + 1]; // G
                            aux[cont + 2] = bitmap.pixels[index1 + 2]; // R
                            cont = cont + 3;

                        }
                    }

                    bitmap.pixels = aux;
                    bitmap.infoheader.biHeight = Width;
                    bitmap.infoheader.biWidth =  Height;
                    bitmap.stride = Math.floor((bitmap.infoheader.biBitCount * bitmap.infoheader.biWidth + 31) / 32) * 4;

                    mirrorh();

                } else if (bitmap.infoheader.biBitCount == 8) {

                    var Height = bitmap.infoheader.biHeight;
                    var Width = bitmap.infoheader.biWidth;
                    var aux = bitmap.pixels.slice();
                    var cont = 0;

                    for (var y = 0; y < Width; ++y) { 
                        for (var x = 0; x < Height; ++x) {

                            var index1 = y + bitmap.stride * x;

                            aux[cont] = bitmap.pixels[index1]; 
                            cont++;

                        }
                    }

                    bitmap.pixels = aux;
                    bitmap.infoheader.biHeight = Width;
                    bitmap.infoheader.biWidth =  Height;
                    bitmap.stride = Math.floor((bitmap.infoheader.biBitCount * bitmap.infoheader.biWidth + 31) / 32) * 4;

                    mirrorh();
                }

                resizeCanvas(bitmap.infoheader.biWidth,bitmap.infoheader.biHeight);

            }

</script>

</body>

</html>
